name: Bot Cycle (4h ON / 4h OFF)

on:
  schedule:
    - cron: "0 * * * *"   # ÙƒÙ„ Ø³Ø§Ø¹Ø© (Ø®ÙÙŠÙ)
  workflow_dispatch:

concurrency:
  group: bot-cycle
  cancel-in-progress: false

jobs:
  cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 260   # Ø£Ù…Ø§Ù†

    steps:
      # ======================================
      # HARD STOP â€” Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ùˆ Ù…Ø´ ÙˆÙ‚ØªÙ‡
      # ======================================
      - name: HARD STOP if not work hour (UTC)
        run: |
          echo "UTC now:"
          date -u

          HOUR=$(date -u +%H)
          WORK_HOURS="1 2 3 4 9 10 11 12 17 18 19 20"

          if [[ ! " $WORK_HOURS " =~ " $HOUR " ]]; then
            echo "â›” Rest hour â€” exiting job"
            exit 78
          fi

          echo "âœ… Working hour â€” starting bot"

      # ======================================
      # Checkout public repo
      # ======================================
      - name: Checkout public repo
        uses: actions/checkout@v4

      # ======================================
      # Checkout private repo
      # ======================================
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: XXB4/RX
          token: ${{ secrets.GH_TOKEN }}
          path: private

      # ======================================
      # Docker setup
      # ======================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================
      # Build Docker image (cached)
      # ======================================
      - name: Build Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ./private
          tags: telegram-bot:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================================
      # Run bot with SMART AUTO-KILL
      # ======================================
      - name: Run bot (smart kill)
        run: |
          docker run --rm telegram-bot bash -c '
          WORK_HOURS="1 2 3 4 9 10 11 12 17 18 19 20"
          END=$((SECONDS+14400))  # 4 hours max

          echo "ğŸš€ Bot started"

          while [ $SECONDS -lt $END ]; do
            HOUR=$(date -u +%H)

            if [[ " $WORK_HOURS " =~ " $HOUR " ]]; then
              python main.py
            else
              echo "â›” Hour $HOUR Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø´ØºÙ„ â€” killing bot"
              exit 0
            fi

            sleep 60
          done

          echo "â±ï¸ Max runtime reached â€” stopping bot"
          '
