name: Bot Cycle (Egypt Inverse Hours)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: bot-cycle
  cancel-in-progress: false

jobs:
  cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 260

    steps:
      # ======================================
      # 1. ูุญุต ุงูููุช (ุชูููุช ูุตุฑ) - ุงูุณุงุนุงุช ุงููุนููุณุฉ
      # ======================================
      - name: HARD STOP if not work hour (Egypt Time)
        run: |
          # ุถุจุท ุงูููุทูุฉ ุงูุฒูููุฉ ููุตุฑ
          export TZ="Africa/Cairo"
          
          echo "๐ช๐ฌ Egypt Time now:"
          date

          HOUR=$(date +%H)
          
          # ุงูุณุงุนุงุช ุงูุฌุฏูุฏุฉ (ุนูุณ ุงููุฏููุฉ)
          # 01-04, 09-12, 17-20
          WORK_HOURS="01 02 03 04 09 10 11 12 17 18 19 20"

          if [[ ! " $WORK_HOURS " =~ " $HOUR " ]]; then
            echo "โ ุงูุณุงุนุฉ ุงูุขู ($HOUR) ุจุชูููุช ูุตุฑ - ุฎุงุฑุฌ ุงูุฌุฏูู ุงูุฌุฏูุฏ. ุฅููุงู ุงูู Job."
            exit 78
          fi

          echo "โ ุงูุณุงุนุฉ ุงูุขู ($HOUR) ุจุชูููุช ูุตุฑ - ูุณููุญ ุจุงูุนูู."

      # ======================================
      # 2. Checkout
      # ======================================
      - name: Checkout public repo
        uses: actions/checkout@v4

      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: XXB4/RX
          token: ${{ secrets.GH_TOKEN }}
          path: private

      # ======================================
      # 3. Docker Setup & Build
      # ======================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./private
          tags: telegram-bot:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ======================================
      # 4. Run bot (Monitor Egypt Time)
      # ======================================
      - name: Run bot (Egypt Time Smart Kill)
        run: |
          docker run --rm -e TZ=Africa/Cairo telegram-bot bash -c '
          
          # ุชุนุฑูู ุงูุณุงุนุงุช ุงููุนููุณุฉ ุฏุงุฎู ุงููููุชูุฑ
          WORK_HOURS=" 01 02 03 04 09 10 11 12 17 18 19 20 "
          
          echo "๐ Starting Python Bot in background (Egypt Time)..."
          
          # ุชุดุบูู ุงูุจูุช ูู ุงูุฎูููุฉ (Background Process)
          python main.py &
          BOT_PID=$!
          
          # ูุฏุฉ ุงูุชุดุบูู ุงููุตูู (4 ุณุงุนุงุช)
          END=$((SECONDS+14400))

          while [ $SECONDS -lt $END ]; do
            # ุงูุชุธุงุฑ ุฏูููุฉ
            sleep 60
            
            # ุงูุชุฃูุฏ ุฃู ุงูุจูุช ูู ูููุงุฑ
            if ! kill -0 $BOT_PID 2>/dev/null; then
                echo "โ๏ธ Bot process died unexpectedly!"
                exit 1
            fi

            # ูุญุต ุงูููุช ุจุชูููุช ูุตุฑ
            CURRENT_HOUR=$(date +%H)
            
            # ุฅุฐุง ุฎุฑุฌูุง ูู ุงูุณุงุนุงุช ุงููุณููุญุฉ
            if [[ ! "$WORK_HOURS" =~ " $CURRENT_HOUR " ]]; then
              echo "โ ุงูุณุงุนุฉ $CURRENT_HOUR (ูุตุฑ) - ุงูุชูู ุงูููุช ุงููุณููุญ. ุฅููุงู ุงูุจูุช..."
              kill $BOT_PID
              exit 0
            fi
          done

          echo "โฑ๏ธ Max runtime reached (4 hours) โ stopping bot"
          kill $BOT_PID
          '
